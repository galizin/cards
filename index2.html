<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>cards</title>
    <link rel="stylesheet" href="./style.css">
    <script src="./script.js"></script>
    <script src="../jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  </head>
  <body>
    <!-- page content -->
  <input />
<script>

class Card {
  constructor(suit,no,vis) {
    this.suit = suit;
    this.no = no;
    this.vis = vis;
  }
  toString = function() {
//    return(this.suit + this.no.toString(16) + this.vis);
    if(this.vis)
      return(this.suit + this.no.toString(16));
    return "xx";
  }
}

class Stack {
  constructor () {
    this.el = [];
  }
}


const initDeck = function(deck) {
  for(let suits = 0; suits < 4; suits++) {
    for(let nos = 0; nos < 13; nos++) {
      deck.push(new Card(suits, nos, 0));
    }
  }
}
  
const shuffleDeck = function(deck) {
  const deck2 = [];
  //initDeck(deck);
  while(deck.length > 0) {  
    let idx = Math.floor(Math.random() * deck.length);
    deck2.push(deck[idx]);
    deck.splice(idx, 1);
  }
  return deck2;
}

const emptyDeck = [];

initDeck(emptyDeck);

const deck = shuffleDeck(emptyDeck);

//$("body").html("<pre>" + deck.map(m => m.toString()).join(',') + "</pre>");

const main=[];

for(let i = 0; i < 7; i++) {
  main.push(new Stack());
}

const discard=[];
for(let i = 0; i < 4; i++) {
  discard.push(new Stack());
}

const stack=[new Stack(), new Stack()];

deck.forEach(m => stack[1].el.push(m));

for(let i = 0; i < 7; i++) {
  for(let j = i; j < 7; j++) {
    if (j == i)
      stack[1].el[0].vis = 1;
    main[j].el.push(stack[1].el[0]);
    stack[1].el.splice(0, 1);
  }
}

stack[1].el.forEach(m => m.vis = 1);

let drawField = function() {
  let line = "";
  for(let i = 0; i<4; i++) {
    line += discard[i].el.length == 0 ? "   " : discard[i].el[discard[i].el.length-1].toString() + " ";
  }  
  for(let i = 0; i<3; i++) {
    line += (stack[0].el.length - 3 + i) < 0 ? "   " : stack[0].el[stack[0].el.length - 3 + i].toString() + " ";
  }
  line += "\n\n";

  let maxlen = 0;
  main.forEach(m => {if (maxlen < m.el.length) {maxlen = m.el.length}});

  for(let j = 0; j < maxlen; j++) {
    for(let i = 0; i < 7; i++) {
      //console.log(i + " " + j + " " + (main[i].el.length - 1));
      if(j == main[i].el.length - 1 && main[i].el[j].vis == 0) {
        main[i].el[j].vis = 1; 
      }
      line += j < main[i].el.length ? main[i].el[j].toString() + " " : "   ";
    }
    line += "\n";
  }
  $("pre").remove(); 
  $("body").append("<pre>" + line + "</pre>");
  $("input").val("");
}

drawField();

getLast = function(inArr) {
  return inArr.el[inArr.el.length - 1];
}

lastMove = function(from, to) {
  to.el.push(getLast(from));
  from.el.splice(from.el.length-1);
}

moveToMain = function(from, to, howmany) {
  if(from.el[from.el.length - howmany].vis = 1) {
    const neededFrom = [...from.el].slice(from.el.length - howmany);
    let doMove = false;
    if (to.el.length == 0 && neededFrom[0].no == 12) {
      doMove = true;
    } else {
      const bottom = getLast(to);
      if (bottom.no == neededFrom[0].no+1 && neededFrom[0].suit %2 != bottom.suit %2) {
        doMove = true;
      }
    }
    if(doMove) {
      from.el.splice(from.el.length -howmany);
      to.el=to.el.concat(neededFrom);
    }
  } 
}

procCmd = function(cmd) {
  switch(cmd.substring(0,1)) {
    case "a":
      if(stack[1].el.length === 0) {
        while(stack[0].el.length > 0) {
          stack[1].el.push(stack[0].el[0]);
          stack[0].el.splice(0,1);
        }        
      }
      for(let i = 0; i < 3; i++) {
        if (stack[1].el.length > 0) {
          stack[0].el.push(stack[1].el[0]);
          stack[1].el.splice(0,1);
        }
      }
      break;
    case "s": //from to how many
      const parm = (cmd.split(" ")).map(m => parseInt(m)).slice(1);
      //const from = main[parm[0]].splice(main[parm[0]].length);
      //const to = main[parm[1]];
      moveToMain(parm[0] == 7 ? stack[0]: main[parm[0]], main[parm[1]], parm[0] == 7 ? 1: parm[2]);      
      break;
    case "d":
      const cmdn = parseInt(cmd.split(" ")[1]);
      moveToMain(stack[0], main[cmdn], 1);
      //const top = getLast(stack[0]);
      //if (main[cmdn].length == 0 && top.no == 12) {
      //  lastMove(stack[0], main[cmdn]);
      //} else {
      //  const bottom = getLast(main[cmdn]);
      //  if (bottom.no == top.no+1 && top.suit %2 != bottom.suit %2) {
      //    lastMove(stack[0], main[cmdn]);      
      //  }
      //}
      break;
    case "r":
      const cmdl = parseInt(cmd.split(" ")[1]);
      let arr;
      if(cmdl < 7) {
        arr = main[cmdl];
      } else {
        arr = stack[0];
      }
//      const lastidx = arr.el.length - 1;
      const lastEl = getLast(arr);
      const discardsuit = discard[lastEl.suit];
      if(discardsuit.el.length == 0 ? lastEl.no == 0 : lastEl.no == getLast(discardsuit).no + 1) {
        lastMove(arr, discardsuit);
//        discardsuit.push(arr[lastidx]);
//        arr.splice(lastidx);
      }
      break;
    default:
      console.log("command " + cmd + " is not supported");
  }
  drawField();
}


$("input").on("keypress", function (e) {
    if(e.key === 'Enter') {
        e.preventDefault();
        //console.log($("input").val());
        procCmd($("input").val());
    }
});


/*  function dragstart_handler(ev) {
    ev.preventDefault();
    // Add the target element's id to the data transfer object
//    ev.dataTransfer.setData("application/my-app", ev.target.id);
  //  ev.dataTransfer.effectAllowed = "move";
    //console.log('start');
  const touches = ev.changedTouches;
const viewportOffset = ev.target.getBoundingClientRect();
// these are relative to the viewport, i.e. the window
//var top = viewportOffset.top;
//var left = viewportOffset.left;
//console.log((viewportOffset.top)  + ' ' + (viewportOffset.left));
//console.log((-viewportOffset.top + touches[0].pageY -6.5)  + ' ' + (-viewportOffset.left + touches[0].pageX - 4.5));
ev.target.setAttribute("touchstartoffset", 
  (-viewportOffset.top + touches[0].pageY -6.5)  + ',' + (-viewportOffset.left + touches[0].pageX - 4.5));
  }
  function dragover_handler(ev) {
    ev.preventDefault();
   // ev.dataTransfer.dropEffect = "move";
    //console.log('move');
  const touches = ev.changedTouches;
//console.log(touches[0].pageX + ' ' + touches[0].pageY);
//console.log(ev);
//console.log(ev.target.getAttribute("touchstartoffset").split(',')[0]);
//console.log(Number(ev.target.getAttribute("touchstartoffset").split[0]));
//console.log((touches[0].pageY + Number(ev.target.getAttribute("touchstartoffset").split[0])) + 'px');
ev.target.closest(".outerspan").style.top = (touches[0].pageY - Number(ev.target.getAttribute("touchstartoffset").split(',')[0])) + 'px';
ev.target.closest(".outerspan").style.left = (touches[0].pageX - Number(ev.target.getAttribute("touchstartoffset").split(',')[1])) + 'px';
//ev.target.closest(".outerspan").style.top = touches[0].pageY + 'px';
//ev.target.closest(".outerspan").style.left = touches[0].pageX + 'px';
//console.log(ev.target.style.top);
//console.log(ev.target.style.left);
//console.log(touches[0].pageX + ' ' + touches[0].pageY);

  }
  function drop_handler(ev) {
    ev.preventDefault();
    // Get the id of the target and add the moved element to the target's DOM
   // const data = ev.dataTransfer.getData("application/my-app");
   // ev.target.prepend(document.getElementById(data));
  }



var num = 0x1f0a0;

cardString = function (cardNum,suit) {
  var red = suit == 0x10 || suit == 0x20 ? 1 : 0; 
  //console.log(red);
  //console.log( '<span draggable="true">' + ((red)?'<mark class="red">':''));// + '&#x' + (num+cardNum+suit).toString(16) + ';' + red?'</mark>':''+'</span>';
//  return '<span draggable="true" class="outerspan" id="' 
  return '<span class="outerspan" id="' 
    + (num+cardNum+suit).toString()  
    + '" ontouchstart="dragstart_handler(event)" >' 
    + ((red)?'<mark class="red">':'') 
    + '<span class="innerspan">&#x' 
    + (num+cardNum+suit).toString(16) 
    + ';</span>' 
    + ((red)?'</mark>':'') 
    + '</span>';
};

window.addEventListener('load', function() {
  //var strnum = '&#x' + num.toString(16) + ';';
  var strnum = cardString(0,0);
  for(var i=1; i<0xf; i++) {
    //strnum += '&#x' + (num+i).toString(16) + ';';
    //strnum += '<mark class="red">&#x' + (num+i+0x10).toString(16) + ';</mark>';
    //strnum += '<mark class="red">&#x' + (num+i+0x20).toString(16) + ';</mark>';
    //strnum += '&#x' + (num+i+0x30).toString(16) + ';';
    //console.log(cardString(i, 0));
    strnum += cardString(i, 0);
    strnum += cardString(i, 0x10);
    strnum += cardString(i, 0x20);
    strnum += cardString(i, 0x30);
  }
  document.getElementById("main").innerHTML = strnum;
});
*/
</script>
<!--<div id="main" ontouchstop="drop_handler(event)" ontouchmove="dragover_handler(event)"  ondrop="drop_handler(event)" ondragover="dragover_handler(event)" />-->
<!--<div id="main" ontouchstop="drop_handler(event)" ontouchmove="dragover_handler(event)" />-->
  </body>
</html>
