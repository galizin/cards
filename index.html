<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>cards</title>
    <link rel="stylesheet" href="./style.css">
    <script src="./script.js"></script>
    <script src="../jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=0.8, user-scalable=0">
  </head>
  <body>
    <!-- page content -->
<script>

function dragstart_handler(ev) {
  ev.preventDefault();
  const touches = ev.changedTouches;
  const el = ev.target.closest(".outerspan");
  const viewportOffset = el.getBoundingClientRect();
  $(el).attr("touchstartoffset", 
    (-viewportOffset.top + touches[0].pageY)  + ',' + (-viewportOffset.left + touches[0].pageX))
    .attr("origLane", leftToLane(parseInt(el.style.left)));
}

function dragover_handler(ev) {
  ev.preventDefault();
  const touches = ev.changedTouches;
  let el = ev.target.closest(".outerspan");
  if (el) { 
    el.style.top = 
      (touches[0].pageY - Number(ev.target.closest(".outerspan").getAttribute("touchstartoffset").split(',')[0])) + 'px';
    el.style.left = 
      (touches[0].pageX - Number(ev.target.closest(".outerspan").getAttribute("touchstartoffset").split(',')[1])) + 'px';
    let sh = 0;
    for(let child of $(el).find('*')) {
      if(child.classList.contains("outerspan")) {
        sh += 15;
        child.style.top = 
          (touches[0].pageY - Number(ev.target.closest(".outerspan").getAttribute("touchstartoffset").split(',')[0])) + sh + 'px';
        child.style.left = 
          (touches[0].pageX - Number(ev.target.closest(".outerspan").getAttribute("touchstartoffset").split(',')[1])) + 'px';
      }
    }
  }
}

function leftToLane(left) {
  let laneNo = -1;
  for(let i=0; i < 7;i++) {
    if((left > hGap/2) && (left < (hGap/2 + hGap + (hGap + hDim)*i))) {
      laneNo = i;
      break;
    } 
  }
  return laneNo;
}

function laneToLeft(laneNo) {
  return( hGap + (hDim + hGap)*laneNo);
}

function drop_handler(ev) {
  ev.preventDefault();
  //console.log(ev);
  const touches = ev.changedTouches;
  let el = ev.target.closest(".outerspan");
  if (el) { 
    //console.log(coordToLane(parseInt(el.style.left)));
    let laneNo = leftToLane(parseInt(el.style.left));
    laneNo = laneNo == -1 ? $(el).attr("origLane"): laneNo;
    $(el).attr("origLane", laneNo);
    el.style.left = laneToLeft(laneNo) + 'px';
    for(let child of $(el).find('*')) {
      if(child.classList.contains("outerspan")) {
        child.style.left = laneToLeft(laneNo) + 'px';
        $(child).attr("origLane", laneNo);
      }
    }    
  }
}

var num = 0x1f0a0;
var offs = 15;
var hDim = 55;
var vDim = 73;
var vGap = 8
var hGap = 7;

cardString = function (cardNum,suit,top,left) {
  let red = suit == 1 || suit == 2 ? 1 : 0; 
  let el = document.createElement("span");
  $(el).attr("class", "outerspan").attr("id", suit.toString(16) + cardNum.toString(16)).attr("ontouchstart", "dragstart_handler(event)")
    .attr("style", "top:" + top + "px; left:" + left + "px").attr("ontouchend", "drop_handler(event)")
    .attr("origLane", leftToLane(left));
  $(el).html(((red)?'<mark class="red">':'') 
    + '<span class="innerspan" ontouchsend="drop_handler(event)">&#x' 
    + (num+(cardNum > 10?cardNum+2:cardNum+1) +suit*0x10).toString(16) 
    + ';</span>' 
    + ((red)?'</mark>':''));
  return el;
};

window.addEventListener('load', function() {
  for(var j = 0; j < 4; j++) {
    let parentEl = null;
    for(var i=0; i<13; i++) {
      el = cardString(i, j, vGap + vGap + vDim + offs*i , hGap + (hGap + hDim)*j );
      if (parentEl) {
        parentEl.append(el);
      } else {
        document.getElementById("main").append(el);
      }
      parentEl = el;
    }
  }
});

</script>
<div id="main" ontouchmove="dragover_handler(event)" ontouchend="drop_handler(event)" /> 
  </body>
</html>
